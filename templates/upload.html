{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Clothes Image</title>
    <script type="text/javascript" src="{% static 'js/upload.js' %}"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body class="vh-100 m-0 p-0" style="background-color: #ecece2;">

    <header class="navbar navbar-dark fixed-top" style="background-color: #76b0e0;">
        <div class="fixed-top text-center p-1"
            style="background-color: #76b0e0;color: #000000; /* 30% grey */ z-index: 1;">
            <a href="/home" class="btn">
                <h2>DressRight</h2>
            </a>
        </div>
    </header>
    <div class="container mt-4 pt-5">
        <div class="card-header" style="background-color: #f0f0f0;">
            <h1 class="mb-0 text-center">Upload Clothes</h1>
        </div>
        <div class="card mb-3">
            <div class="card-body d-flex justify-content-between">
                <div class="container d-flex justify-content-center">
                    <a href="#" class="btn btn-primary">Without AI</a>
                </div>
                <div class="container d-flex justify-content-center">
                    <a href="ai" id="uploadWithAI" class="btn btn-primary">With AI</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container ">
        <div class="card mx-auto col-sm-10 col-md-8 col-lg-6" style="background-color: #eeeee9;">
            <div class="card-body">
                {% for message in messages %}
                <h2 style="color: green;">{{ message }}</h2><br>
                {% endfor %}
                <!-- Placeholder for displaying matching image -->
                <div id="matchingImageContainer" class="mt-4" style="display: none;">
                    <h3 class="text-center">Matching Image</h3>
                    <img id="matchingImage" class="img-fluid mx-auto d-block user-image" src="" alt="Matching Image">
                    <div class="text-center mt-2">
                        <button type="button" id="useMatchingImage" class="btn btn-primary">Use Matching Image</button>
                        <button type="button" id="continueWithUpload" class="btn btn-secondary">Continue with Upload</button>
                    </div>
                </div>
                
                <!-- Form for uploading clothes -->
                <form id="uploadForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="image" class="form-label">Image:</label>
                        <input type="file" id="image" name="image" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="brand" class="form-label">Brand:</label>
                        <input type="text" id="brand" name="brand" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="model" class="form-label">Model:</label>
                        <input type="text" id="model" name="model" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="color" class="form-label">Color:</label>
                        <select id="color" name="color" class="form-select" required>
                            <option value="" disabled selected>Select a color</option>
                            <option value="black">Black</option>
                            <option value="blue">Blue</option>
                            <option value="brown">Brown</option>
                            <option value="red">Red</option>
                            <option value="grey">Grey</option>
                            <option value="white">White</option>
                            <option value="beige">Beige</option>
                            <option value="dark blue">Dark Blue</option>
                            <option value="green">Green</option>
                            <option value="yellow">Yellow</option>
                            <option value="pink">Pink</option>
                            
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category:</label>
                        <select id="category" name="category" onchange="updateSubcategories()" class="form-select" required>
                            <option value="" disabled selected>Select a category</option>
                            <option value="top">Top</option>
                            <option value="bottom">Bottom</option>
                            <option value="shoes">Shoes</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="subcategory" class="form-label">Subcategory:</label>
                        <select id="subcategory" name="subcategory" class="form-select" required>
                            <option value="" disabled selected>Select a subcategory</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="waterproof" class="form-label">Waterproof:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="waterproof" id="waterproof_false" value="0" checked>
                            <label class="form-check-label" for="waterproof_false">False</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="waterproof" id="waterproof_true" value="1">
                            <label class="form-check-label" for="waterproof_true">True</label>
                        </div>
                    </div>
                    <button type="button" id="submitButton" class="btn btn-primary" style="background-color: #76b0e0;">Submit</button>
                </form>
            </div>
        </div>
    </div>

    <h3 style="color: #ecece2;">© 2024 DressRight. All rights reserved.</h3>
    <h3 style="color: #ecece2;">© 2024 DressRight. All rights reserved.</h3>
    <div class="fixed-bottom bg-light p-2 mt-auto" style="position: fixed; bottom: 0; width: 100%; z-index: 3;">
        <div class="container">
            <div class="row justify-content-around">
                <div class="col-3 text-center">
                    <a href="/home" class="btn btn-light"><i style="color: #95c9f4;" class="fa fa-home fa-2x"></i></a>
                </div>
                <div class="col-3 text-center">
                    <a href="/cloths" class="btn btn-light"><i style="color: #95c9f4;" class="fa fa-suitcase fa-2x"></i></a>
                </div>
                <div class="col-3 text-center">
                    <a href="/upload" class="btn btn-secondary"><i style="color: #95c9f4;" class="fa fa-upload fa-2x"></i></a>
                </div>
                <div class="col-3 text-center">
                    <a href="/profile" class="btn btn-light"><i style="color: #95c9f4;" class="fa fa-user fa-2x"></i></a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>

    <!-- Your HTML code remains unchanged -->

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Get form and submit button
        const uploadForm = document.getElementById('uploadForm');
        const submitButton = document.getElementById('submitButton');
        

        // Add event listener for submit button click
        submitButton.addEventListener('click', async function () {
            // Prevent default form submission
            event.preventDefault();

            // Get form data
            const formData = new FormData(uploadForm);

            try {
                // Send form data to the server
                const response = await fetch('/api/find_match/', {
                    method: 'POST',
                    body: formData
                });

                // Check if the response is ok
                if (response.ok) {
                    // Parse response JSON
                    const data = await response.json();

                    // Check if there's a match
                    if (data.hasMatch) {
                        // Show matching image container
                        document.getElementById('matchingImageContainer').style.display = 'block';
                        const matchingImageUrl = '/media/' + data.matchingImageUrl;


                        document.getElementById('matchingImage').src = matchingImageUrl;

                        // Add event listener for 'Use Matching Image' button click
                        document.getElementById('useMatchingImage').addEventListener('click', function () {
                            // Use matching image URL for form submission
                            // Update form data with matching image URL
                            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                            const response_2 = fetch('/api/use_existing/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrftoken
                            },
                            body: JSON.stringify({ image: data.matchingImageUrl })
                        })
                        .then(() => {
                            // Reload the page after the request is completed
                            window.location.reload();
                            });
                        });

                        // Add event listener for 'Continue with Upload' button click
                        document.getElementById('continueWithUpload').addEventListener('click', function () {
                            // Hide matching image container and continue with normal form submission
                            document.getElementById('matchingImageContainer').style.display = 'none';
                            // Submit form
                            uploadForm.submit();
                        });
                    } else {
                        // No match found, submit form as usual
                        uploadForm.submit();
                    }
                } else {
                    // Handle non-ok response
                    console.error('Error:', response.statusText);
                    alert('An error occurred while processing your request. Please try again later.');
                }
            } catch (error) {
                // Handle network error
                console.error('Error:', error);
                alert('A network error occurred. Please check your internet connection and try again.');
            }
        });
    });
</script>

</body>

</html>
